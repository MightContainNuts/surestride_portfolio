{% extends "base.html" %}

<script>
    console.log("jQuery loaded:", typeof $ !== "undefined");
</script>

{% block title %}Ask questions about me!{% endblock %}

{% block content %}
<section>
    <h2>Chatbot</h2>
    <p>Ask me anything about this webpage or myself!</p>
</section>

<section>

    <h1>Chat</h1>
    <div id="chat-box"></div>
    <input type="text" id="message" placeholder="Type your message...">
    <button onclick="sendMessage()">Send</button>

    <script>
        function fetchMessages() {
            $.ajax({
                url: '/chat/get_messages',
                type: 'GET',
                success: function(response) {
                    console.log("API Response:", response);  // Log the full response

                    const messages = response.messages;

                    if (Array.isArray(messages)) {
                        const chatBox = $('#chat-box');
                        chatBox.empty();  // Clear current chat

                        messages.forEach(msg => {
                            // Create a new div for each message and append it
                            const messageElement = $('<div></div>').text(msg.sender + ": " + msg.message);
                            chatBox.append(messageElement);
                        });

                        // Optional: Scroll to the bottom of the chat box
                        chatBox.scrollTop(chatBox[0].scrollHeight);
                    } else {
                        console.error("Error: messages is not an array", messages);
                    }
                },
                error: function(xhr, status, error) {
                    console.error("AJAX Error:", status, error, xhr.responseText);
                }
            });
        }

        function sendMessage() {
            const messageInput = $('#message');
            const message = messageInput.val().trim();  // Trim whitespace

            if (message) {
                const payload = JSON.stringify({ sender: "üôãüèª‚Äç‚ôÇÔ∏è", message: message });

                console.log("Sending payload:", payload);  // Debugging

                $.ajax({
                    url: '/chat/send_message',
                    type: 'POST',
                    contentType: 'application/json',
                    data: payload,
                    success: function(response) {
                        console.log("Response received:", response);
                        messageInput.val('');  // Clear input field
                        fetchMessages();  // Fetch updated messages
                    },
                    error: function(xhr, status, error) {
                        console.error("Error:", status, error, xhr.responseText);  // Debugging
                    }
                });
            } else {
                console.warn("Message input is empty!");
            }
        }
    </script>
</section>

{% endblock %}